# =============================================================================
# Prometheus Configuration for LLM Firewall
# Scrapes metrics from Gateway and Analyzer services
# =============================================================================

global:
  scrape_interval: 15s # Scrape targets every 15 seconds
  evaluation_interval: 15s # Evaluate rules every 15 seconds
  scrape_timeout: 10s # Timeout after 10 seconds

  # Attach these labels to all time series
  external_labels:
    cluster: 'llm-firewall-local'
    environment: 'development'

# Alertmanager configuration (optional - for production)
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets:
#           - alertmanager:9093

# Rule files (for alerts and recording rules)
# rule_files:
#   - '/etc/prometheus/rules/*.yml'

# Scrape configurations
scrape_configs:
  # ---------------------------------------------------------------------------
  # Prometheus self-monitoring
  # ---------------------------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'

  # ---------------------------------------------------------------------------
  # Gateway Service (Node.js + Fastify)
  # ---------------------------------------------------------------------------
  - job_name: 'gateway'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['gateway:3000']
        labels:
          service: 'gateway'
          tier: 'frontend'
          language: 'nodejs'

    # Metric relabeling (optional - customize metric labels)
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: 'firewall_.*'
        action: keep # Only keep metrics starting with "firewall_"

  # ---------------------------------------------------------------------------
  # Analyzer Service (Python + Presidio)
  # ---------------------------------------------------------------------------
  - job_name: 'analyzer'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['analyzer:50051']
        labels:
          service: 'analyzer'
          tier: 'backend'
          language: 'python'

    # Scrape configuration for gRPC metrics
    metric_relabel_configs:
      - source_labels: [__name__]
        regex: '(grpc_.*|analyzer_.*|presidio_.*)'
        action: keep

  # ---------------------------------------------------------------------------
  # Redis Exporter (optional - requires redis_exporter container)
  # ---------------------------------------------------------------------------
  # - job_name: 'redis'
  #   static_configs:
  #     - targets: ['redis-exporter:9121']
  #       labels:
  #         service: 'redis'
  #         tier: 'cache'

  # ---------------------------------------------------------------------------
  # PostgreSQL Exporter (optional - requires postgres_exporter container)
  # ---------------------------------------------------------------------------
  # - job_name: 'postgres'
  #   static_configs:
  #     - targets: ['postgres-exporter:9187']
  #       labels:
  #         service: 'postgres'
  #         tier: 'database'

# Remote write configuration (for long-term storage in production)
# remote_write:
#   - url: 'http://thanos:19291/api/v1/receive'
#     write_relabel_configs:
#       - source_labels: [__name__]
#         regex: 'firewall_.*'
#         action: keep
